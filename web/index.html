<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Supabase Todo | Week 12</title>
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600&display=swap"
    />
    <style>
      :root {
        color-scheme: light dark;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Pretendard", "Segoe UI", Tahoma, sans-serif;
      }

      body {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 24px;
        color: #222;
      }

      .app {
        max-width: 960px;
        margin: 0 auto;
        background: #fff;
        border-radius: 14px;
        padding: 32px;
        box-shadow: 0 18px 55px rgba(0, 0, 0, 0.25);
      }

      h1 {
        font-size: 28px;
        margin-bottom: 18px;
        text-align: center;
      }

      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
        margin-bottom: 32px;
      }

      .card {
        background: #f7f9fc;
        border-radius: 12px;
        padding: 18px;
        border: 1px solid rgba(102, 126, 234, 0.2);
      }

      label {
        font-size: 14px;
        margin-bottom: 6px;
        display: block;
        color: #4a5568;
      }

      input,
      select {
        width: 100%;
        border: 1.5px solid #d6dbe9;
        border-radius: 8px;
        padding: 12px;
        font-size: 15px;
        margin-bottom: 12px;
      }

      button {
        border: none;
        border-radius: 8px;
        padding: 10px 18px;
        font-weight: 600;
        cursor: pointer;
        transition: filter 0.2s ease;
      }

      button.primary {
        background: #667eea;
        color: #fff;
      }

      button.secondary {
        background: #edf2ff;
        color: #4c51bf;
      }

      button.danger {
        background: #fed7d7;
        color: #c53030;
      }

      button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      button:hover:not(:disabled) {
        filter: brightness(0.95);
      }

      .todo-list {
        list-style: none;
      }

      .todo-item {
        background: #fff;
        border-radius: 12px;
        padding: 18px;
        margin-bottom: 12px;
        border: 1px solid #e2e8f0;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .todo-item.completed {
        opacity: 0.6;
        text-decoration: line-through;
      }

      .todo-meta {
        font-size: 13px;
        color: #718096;
        margin-top: 4px;
      }

      .priority-high {
        border-left: 4px solid #f56565;
        padding-left: 14px;
      }

      .priority-medium {
        border-left: 4px solid #ed8936;
        padding-left: 14px;
      }

      .priority-low {
        border-left: 4px solid #48bb78;
        padding-left: 14px;
      }

      .badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        font-size: 13px;
        background: #edf2ff;
        color: #4c51bf;
        border-radius: 999px;
        padding: 4px 10px;
      }

      .message {
        padding: 12px;
        border-radius: 8px;
        margin-bottom: 16px;
      }

      .message.error {
        background: #fed7d7;
        color: #742a2a;
      }

      .message.info {
        background: #e6fffa;
        color: #285e61;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        gap: 12px;
        margin-top: 12px;
      }

      .stat-card {
        background: #fff;
        border-radius: 10px;
        padding: 14px;
        border: 1px solid #e2e8f0;
        text-align: center;
      }

      .stat-card h3 {
        font-size: 14px;
        color: #4a5568;
        margin-bottom: 6px;
      }

      .stat-card p {
        font-size: 20px;
        font-weight: 700;
      }

      @media (max-width: 640px) {
        .app {
          padding: 20px;
        }

        .todo-item {
          flex-direction: column;
          align-items: flex-start;
          gap: 12px;
        }

        .grid {
          grid-template-columns: 1fr;
        }
      }
    </style>
    <script src="./config.js" defer></script>
  </head>
  <body>
    <div class="app">
      <h1>ğŸ“ Supabase Todo Dashboard</h1>

      <div id="global-message" class="message info" style="display: none"></div>

      <section class="grid">
        <article class="card">
          <h2>ğŸ” ì¸ì¦</h2>
          <p style="font-size: 14px; color: #4a5568; margin-bottom: 10px">
            Edge Function(í†µê³„/ì •ë¦¬)ì„ í˜¸ì¶œí•˜ë ¤ë©´ ë¨¼ì € ë¡œê·¸ì¸í•˜ì„¸ìš”.
          </p>
          <form id="auth-form">
            <label for="auth-email">ì´ë©”ì¼</label>
            <input
              id="auth-email"
              type="email"
              placeholder="user@example.com"
              required
            />
            <label for="auth-password">ë¹„ë°€ë²ˆí˜¸</label>
            <input
              id="auth-password"
              type="password"
              placeholder="8ì ì´ìƒ"
              required
            />
            <div style="display: flex; gap: 8px">
              <button class="secondary" data-auth-action="signup">
                íšŒì›ê°€ì…
              </button>
              <button class="primary" data-auth-action="signin">
                ë¡œê·¸ì¸
              </button>
            </div>
          </form>
          <div
            id="auth-state"
            style="
              margin-top: 12px;
              font-size: 14px;
              display: flex;
              justify-content: space-between;
              align-items: center;
            "
          >
            <span>ë¡œê·¸ì¸í•˜ì§€ ì•ŠìŒ</span>
            <button id="logout-btn" class="danger" style="display: none">
              ë¡œê·¸ì•„ì›ƒ
            </button>
          </div>
        </article>

        <article class="card">
          <h2>â• í•  ì¼ ì¶”ê°€</h2>
          <form id="add-todo-form">
            <label for="todo-title">ì œëª©</label>
            <input
              id="todo-title"
              type="text"
              placeholder="í•  ì¼ì„ ì…ë ¥í•˜ì„¸ìš”"
              required
            />

            <label for="todo-priority">ìš°ì„ ìˆœìœ„</label>
            <select id="todo-priority">
              <option value="low">ë‚®ìŒ</option>
              <option value="medium" selected>ë³´í†µ</option>
              <option value="high">ë†’ìŒ</option>
            </select>

            <button class="primary" type="submit" style="width: 100%">
              ì¶”ê°€í•˜ê¸°
            </button>
          </form>
        </article>

        <article class="card">
          <div style="display: flex; justify-content: space-between">
            <h2>ğŸ“Š í†µê³„</h2>
            <div class="badge">
              <span style="font-size: 16px">âš¡</span>
              Edge Function
            </div>
          </div>
          <div
            id="stats-content"
            style="font-size: 14px; color: #4a5568; margin-top: 10px"
          >
            ë¡œê·¸ì¸ í›„ í†µê³„ë¥¼ ì¡°íšŒí•˜ì„¸ìš”.
          </div>
          <div style="display: flex; gap: 8px; margin-top: 12px">
            <button class="secondary" id="refresh-stats-btn">í†µê³„ ìƒˆë¡œê³ ì¹¨</button>
            <button class="danger" id="cleanup-btn">30ì¼ ì§€ë‚œ ì™„ë£Œ ì‚­ì œ</button>
          </div>
          <div class="stats-grid" id="stats-grid"></div>
        </article>
      </section>

      <section class="card" style="margin-bottom: 20px">
        <div style="display: flex; justify-content: space-between">
          <h2>ğŸ“‹ í•  ì¼ ëª©ë¡</h2>
          <button class="secondary" id="refresh-todos-btn">ìƒˆë¡œê³ ì¹¨</button>
        </div>
        <div id="list-message" class="message info" style="display: none"></div>
        <ul id="todo-list" class="todo-list"></ul>
      </section>
    </div>

    <script type="module">
      import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm"

      const config = window.SUPABASE_CONFIG ?? {
        url: "http://127.0.0.1:54321",
        anonKey: "sb_publishable_replace_me",
      }

      if (!config?.url || !config?.anonKey) {
        throw new Error("SUPABASE_CONFIGê°€ ì˜¬ë°”ë¥´ê²Œ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")
      }

      const supabase = createClient(config.url, config.anonKey)

      const todoListEl = document.getElementById("todo-list")
      const addTodoForm = document.getElementById("add-todo-form")
      const todoTitleEl = document.getElementById("todo-title")
      const todoPriorityEl = document.getElementById("todo-priority")
      const listMessageEl = document.getElementById("list-message")
      const globalMessageEl = document.getElementById("global-message")
      const statsContentEl = document.getElementById("stats-content")
      const statsGridEl = document.getElementById("stats-grid")
      const refreshStatsBtn = document.getElementById("refresh-stats-btn")
      const cleanupBtn = document.getElementById("cleanup-btn")
      const refreshTodosBtn = document.getElementById("refresh-todos-btn")
      const authForm = document.getElementById("auth-form")
      const logoutBtn = document.getElementById("logout-btn")
      const authStateEl = document.getElementById("auth-state")

      let currentSession = null

      const showMessage = (el, message, type = "info") => {
        el.textContent = message
        el.className = `message ${type}`
        el.style.display = "block"
        setTimeout(() => {
          el.style.display = "none"
        }, 5000)
      }

      const renderTodos = (todos) => {
        todoListEl.innerHTML = ""

        if (!todos.length) {
          todoListEl.innerHTML =
            '<li class="message info">í•  ì¼ì´ ì—†ìŠµë‹ˆë‹¤. ìƒˆë¡œìš´ í•  ì¼ì„ ì¶”ê°€í•´ë³´ì„¸ìš”!</li>'
          return
        }

        todos.forEach((todo) => {
          const li = document.createElement("li")
          li.className = `todo-item priority-${todo.priority} ${todo.is_completed ? "completed" : ""}`
          li.innerHTML = `
            <div>
              <strong>${todo.title}</strong>
              <div class="todo-meta">
                ìš°ì„ ìˆœìœ„: ${todo.priority} Â· ìƒì„±:
                ${new Date(todo.created_at).toLocaleString()}
              </div>
            </div>
            <div style="display:flex; gap:8px">
              <button class="secondary btn-complete" data-id="${todo.id}" data-completed="${!todo.is_completed}">
                ${todo.is_completed ? "ë¯¸ì™„ë£Œ" : "ì™„ë£Œ"}
              </button>
              <button class="danger btn-delete" data-id="${todo.id}">ì‚­ì œ</button>
            </div>
          `
          todoListEl.appendChild(li)
        })
      }

      const fetchTodos = async () => {
        try {
          const { data, error } = await supabase
            .from("todos")
            .select("*")
            .order("created_at", { ascending: false })

          if (error) throw error
          renderTodos(data)
        } catch (error) {
          showMessage(listMessageEl, `ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ${error.message}`, "error")
        }
      }

      const createTodo = async (title, priority) => {
        const { error } = await supabase.from("todos").insert([{ title, priority }])
        if (error) throw error
      }

      const toggleComplete = async (id, isCompleted) => {
        const { error } = await supabase
          .from("todos")
          .update({ is_completed: isCompleted })
          .eq("id", id)
        if (error) throw error
      }

      const deleteTodo = async (id) => {
        const { error } = await supabase.from("todos").delete().eq("id", id)
        if (error) throw error
      }

      const requireSession = () => {
        if (!currentSession) {
          showMessage(globalMessageEl, "ë¨¼ì € ë¡œê·¸ì¸í•´ì•¼ í•©ë‹ˆë‹¤.", "error")
          return false
        }
        return true
      }

      const callEdgeFunction = async (action, method = "GET") => {
        if (!requireSession()) return

        const url = new URL(`${config.url}/functions/v1/todo-stats`)
        url.searchParams.set("action", action)

        const response = await fetch(url, {
          method,
          headers: {
            Authorization: `Bearer ${currentSession.access_token}`,
            apikey: config.anonKey,
          },
        })

        if (!response.ok) {
          const errBody = await response.text()
          throw new Error(`Edge Function ì˜¤ë¥˜ (${response.status}): ${errBody}`)
        }

        return response.json()
      }

      const updateStatsUI = (stats) => {
        statsContentEl.textContent = ""
        statsGridEl.innerHTML = ""

        const mapping = [
          { label: "ì „ì²´", value: stats.total },
          { label: "ì™„ë£Œ", value: stats.completed },
          { label: "ëŒ€ê¸°", value: stats.pending },
          { label: "ë†’ì€ ìš°ì„ ìˆœìœ„", value: stats.high_priority },
          { label: "ì™„ë£Œìœ¨", value: `${stats.completion_rate}%` },
        ]

        mapping.forEach((stat) => {
          const card = document.createElement("div")
          card.className = "stat-card"
          card.innerHTML = `<h3>${stat.label}</h3><p>${stat.value}</p>`
          statsGridEl.appendChild(card)
        })
      }

      const loadStats = async () => {
        if (!requireSession()) return
        try {
          statsContentEl.textContent = "ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘..."
          const result = await callEdgeFunction("stats", "GET")
          if (result.success) {
            updateStatsUI(result.data)
          } else {
            throw new Error(result.error ?? "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜")
          }
        } catch (error) {
          statsContentEl.textContent = error.message
        }
      }

      const runCleanup = async () => {
        if (!requireSession()) return
        try {
          cleanupBtn.disabled = true
          const result = await callEdgeFunction("cleanup", "POST")
          if (result.success) {
            showMessage(globalMessageEl, result.message ?? "ì •ë¦¬ ì™„ë£Œ", "info")
            await fetchTodos()
            await loadStats()
          } else {
            throw new Error(result.error ?? "ì •ë¦¬ ì‹¤íŒ¨")
          }
        } catch (error) {
          showMessage(globalMessageEl, error.message, "error")
        } finally {
          cleanupBtn.disabled = false
        }
      }

      const updateAuthUI = () => {
        if (currentSession?.user) {
          authStateEl.firstElementChild.textContent = `${currentSession.user.email} ë¡œê·¸ì¸`
          logoutBtn.style.display = "inline-flex"
        } else {
          authStateEl.firstElementChild.textContent = "ë¡œê·¸ì¸í•˜ì§€ ì•ŠìŒ"
          logoutBtn.style.display = "none"
          statsGridEl.innerHTML = ""
          statsContentEl.textContent = "ë¡œê·¸ì¸ í›„ í†µê³„ë¥¼ ì¡°íšŒí•˜ì„¸ìš”."
        }
      }

      authForm.addEventListener("click", async (event) => {
        const target = event.target.closest("[data-auth-action]")
        if (!target) return
        event.preventDefault()

        const email = document.getElementById("auth-email").value.trim()
        const password = document.getElementById("auth-password").value.trim()
        if (!email || !password) {
          showMessage(globalMessageEl, "ì´ë©”ì¼/ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.", "error")
          return
        }

        try {
          target.disabled = true
          if (target.dataset.authAction === "signup") {
            const { error } = await supabase.auth.signUp({ email, password })
            if (error) throw error
            showMessage(globalMessageEl, "íšŒì›ê°€ì… ì™„ë£Œ! ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.", "info")
          } else {
            const { data, error } = await supabase.auth.signInWithPassword({
              email,
              password,
            })
            if (error) throw error
            currentSession = data.session
            updateAuthUI()
            await loadStats()
          }
        } catch (error) {
          showMessage(globalMessageEl, `ì¸ì¦ ì˜¤ë¥˜: ${error.message}`, "error")
        } finally {
          target.disabled = false
        }
      })

      logoutBtn.addEventListener("click", async () => {
        await supabase.auth.signOut()
        currentSession = null
        updateAuthUI()
      })

      addTodoForm.addEventListener("submit", async (event) => {
        event.preventDefault()
        const title = todoTitleEl.value.trim()
        const priority = todoPriorityEl.value
        if (!title) return

        try {
          await createTodo(title, priority)
          addTodoForm.reset()
          await fetchTodos()
          await loadStats()
        } catch (error) {
          showMessage(globalMessageEl, `ì¶”ê°€ ì‹¤íŒ¨: ${error.message}`, "error")
        }
      })

      todoListEl.addEventListener("click", async (event) => {
        const toggleBtn = event.target.closest(".btn-complete")
        const deleteBtn = event.target.closest(".btn-delete")
        try {
          if (toggleBtn) {
            const id = Number(toggleBtn.dataset.id)
            const nextState = toggleBtn.dataset.completed === "true"
            await toggleComplete(id, nextState)
            await fetchTodos()
            await loadStats()
          } else if (deleteBtn) {
            const id = Number(deleteBtn.dataset.id)
            if (confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
              await deleteTodo(id)
              await fetchTodos()
              await loadStats()
            }
          }
        } catch (error) {
          showMessage(globalMessageEl, `ì²˜ë¦¬ ì‹¤íŒ¨: ${error.message}`, "error")
        }
      })

      refreshTodosBtn.addEventListener("click", fetchTodos)
      refreshStatsBtn.addEventListener("click", loadStats)
      cleanupBtn.addEventListener("click", runCleanup)

      const bootstrap = async () => {
        const {
          data: { session },
        } = await supabase.auth.getSession()
        currentSession = session
        updateAuthUI()
        await fetchTodos()
        if (session) {
          await loadStats()
        }

        supabase.auth.onAuthStateChange((_event, session) => {
          currentSession = session
          updateAuthUI()
        })
      }

      bootstrap()
    </script>
  </body>
</html>

